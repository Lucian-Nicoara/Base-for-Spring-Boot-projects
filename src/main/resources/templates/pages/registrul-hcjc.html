<!doctype html>
<html layout:decorate="template" lang="en" data-bs-theme="light">
	<div id="main" layout:fragment="content">
		<table id="dtHotarariCJC" class="display" style="width: 100%;">
			<thead>
				<tr>
					<th style="width:100px; background-color: #ccc;">Nr.</th>
					<th style="width:100px; background-color: #ccc;">Data</th>
					<th style="background-color: #ccc;">Emitent</th>
					<th style="width:100px; background-color: #ccc;">Data comunicării</th>
					<th style="background-color: #ccc;">Compartiment / Persoana / Data primirii</th>
					<th style="width:100px; background-color: #ccc;">Stadiu</th>
					<th style="width:190px; background-color: #ccc;">Operații</th>
				</tr>
				<tr>
					<th data-dt-order="disable"></th>
					<th data-dt-order="disable"></th>
					<th data-dt-order="disable"></th>
					<th data-dt-order="disable"></th>
					<th data-dt-order="disable"></th>
					<th data-dt-order="disable"></th>
					<th data-dt-order="disable"></th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		
		<!-- Modal handle HTML Error -->
		<div class="modal fade" id="modalHandleHtmlError" role="dialog" aria-labelledby="modalHandleHtmlError">
			<div class="modal-dialog modal-xl" role="document">
				<div class="modal-content">
					<div class="modal-header" style="padding: 5px; background-color: #F00;  font-weight: bold; color:#FFF;">
						<div id="titluModal" style="width:100%; text-align: center;">Eroare de aplicatie!</div>
					</div>
					<div class="modal-body">
						<span style="font-weight: bold; margin-bottom: 20px;">Vă rugăm să transmiteți această eroare administratorului IT</span>
						<button class="btn btn-sm btn-success" style="margin-left: 20px;" onclick="copiazaEroarea()"> Copiază eroarea (similar CTRL+C) </button>
						<br>
						<div id="divEroareHtml" style="max-height: 400px; overflow: auto; margin-top:20px; padding-left: 30px; padding-right: 30px; background-color: #EEE;"></div>
					</div>
					<div class="modal-footer" style="background-color: #EEE;">
						<button type="button" class="btn btn-danger" onclick="inchideModalHandleHtmlError()">Închide</button>
					</div>
				</div>
			</div>
		</div>
		<!-- End modal incarca fisier hotarareCJC-->
		
		<!-- Modal adaugare hotarareCJC-->
		<div class="modal fade" id="modalAdaugaHotarareCJC" role="dialog" aria-labelledby="modalAdaugaHotarareCJC">
			<div class="modal-dialog modal-xl" role="document">
				<div class="modal-content">
					<div class="modal-header" style="padding: 5px; background-color: #EEE;  font-weight: bold;">
						<div id="titluModal" style="width:100%; text-align: center;">Adaugă o hotărâre CJC</div>
						<button type="button" class="btn-close" style="margin-right:1px; padding:5px;" onclick="inchideModalAdaugaHCJC()"></button>
					</div>
					<div class="modal-body">
						<div class="row mb-2">
							<div class="col-md-2">
								<label for="nrHotarare" class="fw-bold">Nr. hotărare</label><br>
								<input id="nrHotarare" class="form-control">
							</div>
							<div class="col-md-2">
								<label for="dataHotarare" class="fw-bold">Dată hotărare</label><br>
								<input id="dataHotarare" class="form-control" onchange="onChangeDataHotarare()">
							</div>
							<div class="col-md-4">
								<label for="emitentHotarare" class="fw-bold">Emitent</label><br>
								<input id="emitentHotarare" class="form-control">
							</div>
							<div class="col-md-2">
								<label for="dataCom" class="fw-bold">Data comunicării</label><br>
								<input id="dataCom" class="form-control" onchange="onChangeDataComunicarii()">
							</div>
							<div class="col-md-2">
								<label for="selStadiuHotarare" class="fw-bold">Stadiu</label><br>
								<select id="selStadiuHotarare" class="w-100">
									<option value="În lucru" selected>În lucru</option>
									<option value="Rezolvată">Rezolvată</option>
								</select>
							</div>
						</div>
						<div class="row" style="margin-top:40px; background-color:darkslateblue;">
							<div class="col-md-12" style="color:white; font-weight:bold;">Listă primitori:</div>
						</div>
						<div class="row">
							<div class="col-md-3">
								<label for="selPersoanaPrimire" class="fw-bold">Persoana care a primit-o</label><br>
								<select id="selPersoanaPrimire" class="w-100" onChange = "onChangeSelPersoanaPrimire();">
								</select>
							</div>
							<div class="col-md-5">
								<label for="selCompartiment" class="fw-bold">Compartimentul adresat</label><br>
								<select id="selCompartiment" class="w-100" onChange = "onChangeSelCompartiment();">
								</select>
							</div>
							<div class="col-md-2">
								<label for="dataPrimirii" class="fw-bold">Data primirii</label><br>
								<input id="dataPrimirii" class="form-control" onchange="onChangeDataPrimirii()">
							</div>
							<div class="col-md-2">
								<button id="btnAdaugaPrimitor" type="button" class="btn btn-primary" style="margin-top:24px;" onclick="adaugaPrimitorHCJC()">Adaugă primitor</button>
							</div>
						</div>
						<div class="row" style="margin-top:20px;">
							<div class="col-md-1"></div>
							<div class="col-md-10">
								<table id="tabelPrimitori" class="table table-bordered">
									<thead>
										<tr>
											<th>Persoana</th>
											<th>Compartimentul adresat</th>
											<th>Data primirii</th>
											<th>Acțiuni</th>
										</tr>
									</thead>
									<tbody>
									</tbody>
								</table>
							</div>
							<div class="col-md-1"></div>
						</div>
						<div class="row">
							<div id="divMesajAdaugaHotarare" class="col-md-12" style="color: red; font-weight: bold;"></div>
						</div>
					</div>
					<div class="modal-footer" style="background-color: #EEE;">
						<button id="btnSalveazaHotarare" type="button" class="btn btn-success" onclick="salveazaHotarareCJC()">Salvează</button>
						<button type="button" class="btn btn-danger" onclick="inchideModalAdaugaHCJC()">Închide</button>
					</div>
				</div>
			</div>
		</div>
		<!-- End modal adaugare hotarareCJC-->
		
		<!-- Modal incarca fisier hotarareCJC-->
		<div class="modal fade" id="modalAdaugaFisierHotarareCJC" role="dialog" aria-labelledby="modalAdaugaFisierHotarareCJC">
			<div class="modal-dialog modal-xl" role="document">
				<div class="modal-content">
					<div class="modal-header" style="padding: 5px; background-color: #EEE;  font-weight: bold;">
						<div id="titluModal" style="width:100%; text-align: center;">Adaugă fișier hotărâre CJC</div>
						<button type="button" class="btn-close" style="margin-right:1px; padding:5px;" onclick="inchideModalAdaugaFisierHCJC()"></button>
					</div>
					<form method="POST" enctype="multipart/form-data" id="formFisierHotarareCJC">
					<div class="modal-body">
						<div style="padding: 15px; box-shadow: 0 8px 6px -6px #eee;">
							<div class="row mb-2">
								<div class="col">
									<label class="fw-bold">Nr. hotărare</label><br>
									<span id="divNrHotarare2"></span>
								</div>
								<div class="col">
									<label class="fw-bold">Emitent</label><br>
									<span id="divEmitentHotarare2"></span>
								</div>
								<div class="col">
									<label class="fw-bold">Data comunicării</label><br>
									<span id="divDataCom2"></span>
								</div>
								<div class="col-md-3">
									<label class="fw-bold">Comp./pers. adresată</label><br>
									<span id="divCompartimentul2"></span>
								</div>
								<div class="col">
									<label class="fw-bold">Data primirii</label><br>
									<span id="divDataPrimirii2"></span>
								</div>
								<div class="col">
									<label class="fw-bold">Stadiu</label><br>
									<span id="divStadiuHotarare2"></span>
								</div>
							</div>
						</div>
						<div style="width: 100%; text-align: center; padding: 30px;">
							<label class="fw-bold">Alege fișierul:</label>
							<input type="file" id="fisierHotarareCJC" name="fisierHotarareCJC" style="width: 400px;"/>	
						</div>
					</div>
					</form>
					<div class="modal-footer" style="background-color: #EEE;">
						<button id="btnSalveazaHotarare" type="button" class="btn btn-success" onclick="incarcaFisierul()">Salvează</button>
						<button type="button" class="btn btn-danger" onclick="inchideModalAdaugaFisierHCJC()">Închide</button>
					</div>
				</div>
			</div>
		</div>
		<!-- End modal incarca fisier hotarareCJC-->
		
		<!-- Modal arata fisier hotarareCJC-->
		<div class="modal fade" id="modalArataFisierHCJC" role="dialog" aria-labelledby="modalArataFisierHCJC" tabindex='-1'>
			<div class="modal-dialog modal-xl" role="document">
				<div class="modal-content">
					<div class="modal-header" style="padding: 5px; background-color: #EEE;  font-weight: bold;">
						<div id="titluModal" style="width:100%; text-align: center;">Fișier hotărâre CJC</div>
						<button type="button" class="btn-close" style="margin-right:1px; padding:5px;" onclick="inchideModalArataFisierHCJC()"></button>
					</div>
					<div class="modal-body" style="padding: 0px;">
						<iframe id="embedFisierHCJC" class="w-100" style="height:600px;"></iframe>
					</div>
					<div class="modal-footer" style="background-color: #EEE;">
						<a id="linkBtnDescarcaFisierHCJC" href="" ><button id="btnDescarcaFisierHCJC" type="button" class="btn btn-success">Descarcă fișierul</button></a>
						<button type="button" class="btn btn-danger" onclick="inchideModalArataFisierHCJC()">Închide</button>
					</div>
				</div>
			</div>
		</div>
		<!-- End modal arata fisier hotarareCJC-->
		
		<!-- Modal adaugare hotarareCJC-->
		<div class="modal fade" id="modalNote" role="dialog" aria-labelledby="modalNote">
			<div class="modal-dialog modal-xl" role="document">
				<div class="modal-content">
					<div class="modal-header" style="padding: 5px; background-color: #EEE;  font-weight: bold;">
						<div id="titluModal" style="width:100%; text-align: center;">Notițe hotărâre CJC</div>
						<button type="button" class="btn-close" style="margin-right:1px; padding:5px;" onclick="inchideModalNote()"></button>
					</div>
					<div class="modal-body" style="padding: 0px; max-height: 600px;">
						<div style="padding: 15px; box-shadow: 0 8px 6px -6px #eee;">
							<div class="row mb-2">
								<div class="col">
									<label class="fw-bold">Nr. hotărare</label><br>
									<span id="divNrHotarare1"></span>
								</div>
								<div class="col">
									<label class="fw-bold">Emitent</label><br>
									<span id="divEmitentHotarare1"></span>
								</div>
								<div class="col">
									<label class="fw-bold">Data comunicării</label><br>
									<span id="divDataCom1"></span>
								</div>
								<div class="col">
									<label class="fw-bold">Stadiu</label><br>
									<span id="divStadiuHotarare1"></span>
								</div>
							</div>
						</div>
						<div class="row mx-0">
							<div class="col-9">
								<div id="divNote" class="container d-flex flex-wrap px-3 py-2" style="overflow: auto; max-height: 450px;"> 
									
								</div>								
							</div>
							<div class="col-3" style="text-align: center;">
								<div class="card text-dark bg-light mb-2 mt-2 shadow" style="text-align: center;">
									<div class="card-header fw-bold">Adaugă notiță nouă</div>
									<div class="card-body">
										<textarea id="continutNota" class="form-control mb-2" style="width: 100%; height: 200px;" placeholder="Conținut notiță"></textarea>
										<button id="btnSalveazaNota" type="button" class="btn btn-light shadow" onclick="adaugaNota()">Salvează notița</button>
									</div>
								</div>
								
							</div>
						</div>
					</div>
					<div class="modal-footer" style="background-color: #EEE;">
						<button type="button" class="btn btn-danger" onclick="inchideModalNote()">Închide</button>
					</div>
				</div>
			</div>
		</div>
		<!-- End modal adaugare hotarareCJC-->
		
	</div>
</html>
<script th:inline="javascript">
	var token = $("meta[name='_csrf']").attr("content");
	var mesajAdaugaHotarare = "";
	var dtHotarariCJC = null;
	var hotarareaCurenta = null;
	var primitoriHCJC = [];
	var listaPersoane = [];
	var listaCompartimente = [];
	
	$(document).ready(function() {
		hotarareaCurenta = null;
		primitoriHCJC = [];
		console.log("Registul hotarari CJC - ready!");
		$("#divTitluPagina").html("Registrul Hotărâri CJC");
		
		<!--Activare bootstrap tooltips-->
		var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
		var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
			return new bootstrap.Tooltip(tooltipTriggerEl)
		});
			
		$(".btnMenu").removeClass("btn-primary");
		$("#menuEntryRegHotCJC").removeClass("btn-light");
		$("#menuEntryRegHotCJC").addClass("btn-primary  fw-bold");
		incarcaDtHotarariCJC();
	});
	
	function handleHtmlError(htmlError){
		$(".modal").modal("hide");
		$("#divEroareHtml").html(htmlError);
		$("#modalHandleHtmlError").modal({backdrop: "static", keyboard: false}).modal("show");
	}
	
	function inchideModalHandleHtmlError(){
		$("#divEroareHtml").html("");
		$("#modalHandleHtmlError").modal("hide");
		hotarareaCurenta = null;
		window.location.reload();
	}
	
	function copiazaEroarea(){
		navigator.clipboard.writeText($("#divEroareHtml").html()).then(function () {
		    alert("Textul a fost copiat. Poti folosi CTRL+V")
		}, function () {
		    alert("Textul nu a putut fi copiat. Trebuie selectat si copiat manual.")
		});
	}
	
	function incarcaDtHotarariCJC(){
		DataTable.datetime('DD.MM.YYYY');
		if ($.fn.DataTable.isDataTable("#dtHotarariCJC")) {
			$("#dtHotarariCJC").DataTable().clear().destroy();
		}
		dtHotarariCJC = $("#dtHotarariCJC").DataTable({
			language: {
				url: 'https://cdn.datatables.net/plug-ins/2.3.3/i18n/ro.json',
			},
			layout: {
				topStart: {
					buttons: [
						{
							text: 'Adaugă înregistrare nouă',
							action: function (e, dt, node, config) {
								arataModalAdaugaInregHCJC();
							}
						},
						//"excel",
						{extend: 'excelHtml5',
							title: 'DGASPC_Hotarari_CJC_' + getTodayDate(),
							exportOptions: {
								columns: [0, 1, 2, 3, 4, 5]
							}
						},
						{extend: 'pdfHtml5',
							title: 'DGASPC_Hotarari_CJC_' + getTodayDate(),
							orientation: 'landscape',
                    		pageSize: 'A4',
							exportOptions: {
								columns: [0, 1, 2, 3, 4, 5]
							}
                    	}
                    ]
				}
			},
			autoWidth: false,
			paging: true,
			order: false,
			lengthChange: false,
			ajax: "/hotarariCJC/getHotarariCJC",
			drawCallback:function(){
				var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
				var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
					return new bootstrap.Tooltip(tooltipTriggerEl)
				});
			},
			columns: [
				{ data: "nrHotarare" },
				{ data: "dataHotarare" },
				{ data: "emitent" },
				{ data: "dataComunicarii" },
				{ data: 
					null, 
					render: function (data, type, row, meta) {
						if(data.listaPrimitori != null && data.listaPrimitori.length > 0){
							var html = '<div style="max-height:120px; overflow: auto;"><table style="width:100%; border: 1px solid grey">';
							data.listaPrimitori.forEach(function(primitor){
								html += '<tr> <td style="border: 1px solid #ccc">' + primitor.compartimentulAdresat + '</td> <td style="width:220px; border: 1px solid #ccc">' + primitor.persoanaPrimire + '</td> <td style="width:80px; border: 1px solid #ccc">' + primitor.dataPrimirii + '</td></tr>';
							});
							html += "</table></div>";
							return html;
						}else{
							return "-";
						}
					}
				},
				//{ data: "compartimentulAdresat" },
				//{ data: "persoanaPrimire"},
				//{ data: "dataPrimirii"},
				{ data: "stadiu"},
				{ data: 
					null, 
					render: function (data, type, row, meta) {
						var arataBtnArataFisier = "";
						if(data.numeFisier != null && data.numeFisier != ""){
							arataBtnArataFisier = '<i class="fa-button bi bi-file-earmark-text" style="margin-right:15px; color:purple;" data-bs-toggle="tooltip" title="Afișează fișierul" onclick="arataModalArataFisierHCJC(' + meta.row + ')"></i>';
						}
						return ''
						+ '<i class="fa-button bi bi-pencil-square" style="margin-right:15px; color:green;" data-bs-toggle="tooltip" title="Editare" onclick="editareHotarareCJC(' + meta.row + ')"></i>'
						+ '<i class="fa-button bi bi-chat-left-text" style="margin-right:15px; color:orange;" data-bs-toggle="tooltip" title="Notițe" onclick="arataModalNote(' + meta.row + ')"></i>'
						+ '<i class="fa-button bi bi-file-earmark-arrow-up" style="margin-right:15px; color:purple;" data-bs-toggle="tooltip" title="Încarcă fișier" onclick="arataModalAdaugaFisierHCJC(' + meta.row + ')"></i>'
						+ arataBtnArataFisier
						+ '<i class="fa-button bi bi-trash" style="margin-right:15px; color:red;" data-bs-toggle="tooltip" title="Șterge înregistrarea" onclick="stergeHotarareCJC(' + meta.row + ')"></i>';
					}
				}
			]
		});
		//adauga filtre coloane
		$("#dtHotarariCJC thead tr:eq(1) th").each(function(i){
			if(i < ($("#dtHotarariCJC thead tr:eq(1) th").length - 1)){
				var title = $("#dtHotarariCJC thead th").eq($(this).index()).text();
				$(this).html('<input class="filtru-coloane w-100" type="text" placeholder="' + title + '" data-index="' + i + '" />');	
			}
			if(i == $("#dtHotarariCJC thead tr:eq(1) th").length -1){
				$(this).html('<button id="btnResetareFiltre" type="button" class="w-100" onclick="onClickReseteazaFiltre();">Resetează</button>');
			}
		});
		
		$("#main .filtru-coloane").on("keyup", function(){
			dtHotarariCJC.column($(this).data('index')).search(this.value).draw();
		});
	}
	
	function onClickReseteazaFiltre(){
		//incarcaDtHotarariCJC();
		location.reload();
	}
	
	function arataModalAdaugaInregHCJC(){
		hotarareaCurenta = null;
		primitoriHCJC = [];
		$("#tabelPrimitori").hide();
		$("#nrHotarare").val("");
		$("#dataHotarare").val("");
		$("#emitentHotarare").val("");
		$("#dataCom").val("");
		$("#dataPrimirii").val("");
		$("#selStadiuHotarare").val("În lucru").select2({
			theme: "bootstrap-5", 
			dropdownParent: $("#modalAdaugaHotarareCJC"), 
			minimumResultsForSearch: -1
		});
		
		$("#selCompartiment").empty();
		$("#selCompartiment").append('<option value="">Alege...</option>');
		$("#selPersoanaPrimire").empty();
		$("#selPersoanaPrimire").append('<option value="">Alege...</option>');

		$.ajax({
			url: "/note/getLov",
			type: "GET",
			success: function(response) {
				listaPersoane = response.listaPersoane;
				listaCompartimente = response.listaCompartimente;
				
				for (const c of response.listaCompartimente) {
					$("#selCompartiment").append('<option value="' + c.id + '">' + c.nume + '</option>');
				}
				$("#selCompartiment").select2({theme: "bootstrap-5", dropdownParent: $("#modalAdaugaHotarareCJC")});

				for (const p of response.listaPersoane) {
					$("#selPersoanaPrimire").append('<option value="' + p.id + '">' + p.nume + ' ' + p.prenume + '</option>');
				}
				$("#selPersoanaPrimire").select2({theme: "bootstrap-5", dropdownParent: $("#modalAdaugaHotarareCJC")});
				
				$("#modalAdaugaHotarareCJC").modal({backdrop: "static", keyboard: false}).modal("show");
				setTimeout(function(){
					$("#nrHotarare").focus();
				}, 200);
			},
			error: function(response){
				handleHtmlError(response.responseText);
			}
		});
	}
	
	function inchideModalAdaugaHCJC(){
		$("#modalAdaugaHotarareCJC").modal("hide");
		hotarareaCurenta = null;
		primitoriHCJC = [];
	}
	
	function verificaData(dataInput){
		var dateArray = dataInput.split(".");
		var ziuaOk = false;
		var lunaOk = false;
		var anulOk = false;
		if(dateArray.length == 3){
			if(parseInt(dateArray[0]) > 0 && parseInt(dateArray[0]) <= 31){
				ziuaOk = true;
			}
			if(parseInt(dateArray[1]) > 0 && parseInt(dateArray[1]) <= 12){
				lunaOk = true;
			}
			if(dateArray[2].length == 4 && parseInt(dateArray[2]) > 1900 && parseInt(dateArray[2]) <= 2199){
				anulOk = true;
			}
		}else{
			return "notok";
		}
		
		if(!ziuaOk || !lunaOk || !anulOk){
			return "notok";
		}else{
			return "ok";
		}
	}
	
	function onChangeDataHotarare(){
		if(verificaData($("#dataHotarare").val()) != "ok"){
			//$("#dataHotarare").val("dd.mm.yyyy");
			$("#divMesajAdaugaHotarare").html("Eroare!<br>Câmpul dată hotărâre trebuie să fie în formatul dd.mm.yyyy!");
			$("#btnSalveazaHotarare").prop("disabled", true);
		}else{
			$("#divMesajAdaugaHotarare").html("");
			$("#btnSalveazaHotarare").prop("disabled", false);
		}
	}
	
	function onChangeDataComunicarii(){
		if(verificaData($("#dataCom").val()) != "ok"){
			//$("#dataCom").val("dd.mm.yyyy");
			$("#divMesajAdaugaHotarare").html("Eroare!<br>Câmpul data comunicării trebuie să fie în formatul dd.mm.yyyy!");
			$("#btnSalveazaHotarare").prop("disabled", true);
		}else{
			$("#divMesajAdaugaHotarare").html("");
			$("#btnSalveazaHotarare").prop("disabled", false);
		}
	}
	
	function onChangeDataPrimirii(){
		if(verificaData($("#dataPrimirii").val()) != "ok"){
			//$("#dataPrimirii").val("dd.mm.yyyy");
			$("#divMesajAdaugaHotarare").html("Eroare!<br>Câmpul data primirii trebuie să fie în formatul dd.mm.yyyy!");
			$("#btnSalveazaHotarare").prop("disabled", true);
		}else{
			$("#divMesajAdaugaHotarare").html("");
			$("#btnSalveazaHotarare").prop("disabled", false);
		}
	}

	function salveazaHotarareCJC(){
		var eroareValidare = false;
		var urlSalvare = "/hotarariCJC/postHotarareCJC";
		if(!$("#nrHotarare").val()){
			eroareValidare = true;
			$("#divMesajAdaugaHotarare").html("Completează câmpul nr. hotărâre");
			return;
		}
		if(verificaData($("#dataHotarare").val()) != "ok"){
			eroareValidare = true;
			$("#divMesajAdaugaHotarare").html("Completează câmpul dată hotărâre");
			return;
		}
		if(!$("#emitentHotarare").val()){
			eroareValidare = true;
			$("#divMesajAdaugaHotarare").html("Completează câmpul: emitent");
			return;
		}
		if(verificaData($("#dataCom").val()) != "ok"){
			eroareValidare = true;
			$("#divMesajAdaugaHotarare").html("Completează câmpul: data comunicării");
			return;
		}
		/* if(!$("#selPersoanaPrimire").val()){
			eroareValidare = true;
			$("#divMesajAdaugaHotarare").html("Completează câmpul: persoana primire");
			return;
		}
		if(!$("#selCompartiment").val()){
			eroareValidare = true;
			$("#divMesajAdaugaHotarare").html("Completează câmpul: compartimentul adresat");
			return;
		}
		if(verificaData($("#dataPrimirii").val()) != "ok"){
			eroareValidare = true;
			$("#divMesajAdaugaHotarare").html("Completează câmpul: data primirii");
			return;
		} */
		if(primitoriHCJC == null || primitoriHCJC.length == 0){
			if($("#selPersoanaPrimire").val() && $("#selCompartiment").val() && $("#dataPrimirii").val()){
				adaugaPrimitorHCJC();
			}else{
				eroareValidare = true;
				$("#divMesajAdaugaHotarare").html("Nu au fost adăugați primitori în listă!");
				return;
			}
		}
		
		
		if(!eroareValidare){
			var hotarareCJC = {
					"nrHotarare": $("#nrHotarare").val(),
					"dataHotarare": $("#dataHotarare").val(),
					"emitent": $("#emitentHotarare").val(),
					"dataComunicarii": $("#dataCom").val(),
					"listaPrimitori": primitoriHCJC,
					"stadiu": $("#selStadiuHotarare").val(),
				};
			var resetPaging = true;
			if(hotarareaCurenta != null && hotarareaCurenta.id != null){
				urlSalvare = "/hotarariCJC/putHotarareCJC";
				hotarareCJC.id = hotarareaCurenta.id;
				resetPaging = false;
			}
			$.ajax({
				url: urlSalvare,
				type: "POST",
				headers: {"X-CSRF-TOKEN": token},
				contentType: "application/json",
				data: JSON.stringify(hotarareCJC),
				success: function(response) {
					inchideModalAdaugaHCJC();
					if(!resetPaging){
						dtHotarariCJC.ajax.reload(null, resetPaging);
					}else{
						location.reload();
					}
				},
				error: function(response){
					handleHtmlError(response.responseText);
				}
			});
		}else{
			alert("Formularul nu este completat corect! Datele nu pot fi salvate.");
		}
	}
	
	function editareHotarareCJC(rowIndex){
		hotarareaCurenta = dtHotarariCJC.row(rowIndex).data();
		$("#tabelPrimitori").hide();
		$("#selCompartiment").empty();
		$("#selCompartiment").append('<option value="">Alege...</option>');
		$("#selPersoanaPrimire").empty();
		$("#selPersoanaPrimire").append('<option value="">Alege...</option>');

		$.ajax({
			url: "/note/getLov",
			type: "GET",
			success: function(response) {
				listaPersoane = response.listaPersoane;
				listaCompartimente = response.listaCompartimente;
				
				for (const c of response.listaCompartimente) {
					$("#selCompartiment").append('<option value="' + c.id + '">' + c.nume + '</option>');
				}
				$("#selCompartiment").val("").select2({theme: "bootstrap-5", dropdownParent: $("#modalAdaugaHotarareCJC")});

				for (const p of response.listaPersoane) {
					$("#selPersoanaPrimire").append('<option value="' + p.id + '">' + p.nume + ' ' + p.prenume + '</option>');
				}
				$("#selPersoanaPrimire").val("").select2({theme: "bootstrap-5", dropdownParent: $("#modalAdaugaHotarareCJC")});
				
				$("#modalAdaugaHotarareCJC").modal({backdrop: "static", keyboard: false}).modal("show");
				setTimeout(function(){
					$("#nrHotarare").focus();
				}, 200);
			},
			error: function(response){
				handleHtmlError(response.responseText);
			}
		});
		$("#nrHotarare").val(hotarareaCurenta.nrHotarare);
		$("#dataHotarare").val(hotarareaCurenta.dataHotarare);
		$("#emitentHotarare").val(hotarareaCurenta.emitent);
		$("#dataCom").val(hotarareaCurenta.dataComunicarii);
		$("#selStadiuHotarare").val(hotarareaCurenta.stadiu).select2({
			theme: "bootstrap-5", 
			dropdownParent: $("#modalAdaugaHotarareCJC"),
			minimumResultsForSearch: -1
		});
		
		if(hotarareaCurenta.listaPrimitori != null && hotarareaCurenta.listaPrimitori.length > 0){
			primitoriHCJC = [];
			primitoriHCJC = primitoriHCJC.concat(hotarareaCurenta.listaPrimitori);
			buildTabelPrimitori();
		}
		
		$("#modalAdaugaHotarareCJC").modal({backdrop: "static", keyboard: false}).modal("show");
	}
	
	function arataModalAdaugaFisierHCJC(rowIndex){
		hotarareaCurenta = dtHotarariCJC.row(rowIndex).data();
		$("#divNrHotarare2").html(hotarareaCurenta.nrHotarare + " / " + hotarareaCurenta.dataHotarare);
		$("#divEmitentHotarare2").html(hotarareaCurenta.emitent);
		$("#divDataCom2").html(hotarareaCurenta.dataComunicarii);
		$("#divCompartimentul2").html(hotarareaCurenta.compartimentulAdresat + " / " + hotarareaCurenta.persoanaPrimire);
		$("#divDataPrimirii2").html(hotarareaCurenta.dataPrimirii);
		$("#divStadiuHotarare2").html(hotarareaCurenta.stadiu);
		
		$("#fisierHotarareCJC").val("");
		$("#modalAdaugaFisierHotarareCJC").modal({backdrop: "static", keyboard: false}).modal("show");
	}

	function inchideModalAdaugaFisierHCJC(){
		hotarareaCurenta = null;
		$("#fisierHotarareCJC").val("");
		$("#modalAdaugaFisierHotarareCJC").modal("hide");
	}
	
	function incarcaFisierul(rowIndex){
		var form = $("#formFisierHotarareCJC")[0];
		var data = new FormData(form);
		data.append("idHotarare", hotarareaCurenta.id);

		$.ajax({
			url : "/hotarariCJC/incarcaFisier",
			headers: {"X-CSRF-TOKEN": token},
			type : "POST",
			data: data,
			enctype: "multipart/form-data",
			processData: false,  // tell jQuery not to process the data
			contentType: false,  // tell jQuery not to set contentType
			cache: false,
			success : function(data) {
				if(data == "ok"){
					inchideModalAdaugaFisierHCJC();
					dtHotarariCJC.ajax.reload(null, false);
					//incarcaDtHotarariCJC();
				}
			},
			error: function(response) {
				alert(response.status);
				handleHtmlError(response.responseText);
			}
		});
	}
	
	function arataModalNote(rowIndex){
		hotarareaCurenta = dtHotarariCJC.row(rowIndex).data();
		$("#divNrHotarare1").html(hotarareaCurenta.nrHotarare + " / " + hotarareaCurenta.dataHotarare);
		$("#divEmitentHotarare1").html(hotarareaCurenta.emitent);
		$("#divDataCom1").html(hotarareaCurenta.dataComunicarii);
		$("#divStadiuHotarare1").html(hotarareaCurenta.stadiu);
		
		incarcaNote(hotarareaCurenta.id, "registrulHCJC");
	}
	
	function incarcaNote(id, entitate){
		$.ajax({
			url: "/note/getNote?id=" + id + "&entitate=" + entitate,
			type: "GET",
			success: function(response) {
				var htmlNote = "";
				for (const nota of response) {
					htmlNote += '<div class="card text-dark bg-light mb-3 shadow" style="max-width: 18rem; margin-right: 20px;">'
						+ '<div class="card-header fw-bold ">' + nota.data + ' ' + nota.persoana.prenume + ' ' + nota.persoana.nume + ':</div>'
						+ '<div class="card-body">'
						+	'<p class="card-text">' + nota.text + '</p>'
						+ '</div>'
					+'</div>';
				}
				
				$("#divNote").html(htmlNote);
				$("#modalNote").modal({backdrop: "static", keyboard: false}).modal("show");
			},
			error: function(response){
				handleHtmlError(response.responseText);
			}
		});
	}
	
	function inchideModalNote(){
		$("#divNote").html("");
		$("#continutNota").val("");
		$("#modalNote").modal("hide");
		hotarareaCurenta = null;
	}
	
	function adaugaNota(){
		if($("#continutNota").val()){
			var nota = {
					"idEntitate": hotarareaCurenta.id,
					"entitate": "registrulHCJC",
					"text": $("#continutNota").val(),
				};
			$.ajax({
				url: "/note/postNota",
				type: "POST",
				headers: {"X-CSRF-TOKEN": token},
				contentType: "application/json",
				data: JSON.stringify(nota),
				success: function(response) {
					if(response == "ok"){
						$("#continutNota").val("");
						incarcaNote(hotarareaCurenta.id, "registrulHCJC");
					}else{
						alert("Nota nu a fost salvata! Eroare de aplicatie.");
					}
				},
				error: function(response){
					handleHtmlError(response.responseText);
				}
			});
		}else{
			alert("Completați conținutul! Nota nu a fost salvată.");
		}
	}
	
	function stergeHotarareCJC(rowIndex){
		hotarareaCurenta = dtHotarariCJC.row(rowIndex).data();
		bootbox.confirm({
			size: "large",
			title: "Șterg?",
			message: "Sunteți sigur că doriți ștergerea hotărârii nr. " + hotarareaCurenta.nrHotarare + " / " + hotarareaCurenta.dataHotarare + " ?",
			buttons: {
				confirm: {
					label: 'Da',
					className: 'btn-success'
				},
				cancel: {
					label: '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Nu &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
					className: 'btn-danger'
				}
			},
			swapButtonOrder: true,
			callback: function(confirmare){
				if(confirmare){
					$.ajax({
						url: "/hotarariCJC/stergeHotarareCJC",
						type: "POST",
						headers: {"X-CSRF-TOKEN": token},
						contentType: "application/json",
						data: hotarareaCurenta.id,
						success: function(response) {
							if(response == "ok"){
								dtHotarariCJC.ajax.reload(null, false);
							}else{
								alert("Ștergerea nu a fost efectuată! Eroare de aplicație.");
							}
							hotarareaCurenta = null;
						},
						error: function(response){
							handleHtmlError(response.responseText);
							hotarareaCurenta = null;
						}
					});
				}
			}
		});
	}
	
	function arataModalArataFisierHCJC(rowIndex){
		hotarareaCurenta = dtHotarariCJC.row(rowIndex).data();
		$("#embedFisierHCJC").attr("src", "/hotarariCJC/arataFisier/"+hotarareaCurenta.id);
		$("#linkBtnDescarcaFisierHCJC").attr("href", "/hotarariCJC/downloadFisier/"+hotarareaCurenta.id);
		
		$("#modalArataFisierHCJC").modal("show");
	}
	
	function inchideModalArataFisierHCJC(){
		$("#modalArataFisierHCJC").modal("hide");
		hotarareaCurenta = null;
	}
	
	function adaugaPrimitorHCJC(){
		if($("#selCompartiment").val() && $("#selPersoanaPrimire").val() && $("#dataPrimirii").val()){
			primitor = {
				"idCompartiment": $("#selCompartiment").val(),
				"compartimentulAdresat": $('#selCompartiment').select2("data")[0].text,
				"idPersoanaPrimire": $("#selPersoanaPrimire").val(),
				"persoanaPrimire": $('#selPersoanaPrimire').select2("data")[0].text,
				"dataPrimirii": $("#dataPrimirii").val()
			}
			primitoriHCJC.push(primitor);
			buildTabelPrimitori();
		}else{
			bootbox.alert("Nu ați completat toate datele pentru primitor!");
		}
	}
	
	function buildTabelPrimitori(){
		$("#tabelPrimitori tbody").empty();
		if(primitoriHCJC != null && primitoriHCJC.length > 0){
			$("#tabelPrimitori").show();
			primitoriHCJC.forEach(function(p, index){
				$("#tabelPrimitori tbody").append('<tr><td>' + p.persoanaPrimire + '</td><td>' + p.compartimentulAdresat + '</td><td>' + p.dataPrimirii + '</td> <td style="text-align:center;"><button class="btn btn-sm btn-danger" onclick="stergePrimitor(' + index + ')">Șterge</button></td></tr>');
			});
		}
	}
	
	function stergePrimitor(index){
		if(primitoriHCJC != null && primitoriHCJC.length > 0){
			primitoriHCJC.splice(index, 1);
			buildTabelPrimitori();
		}
	}
	
	function onChangeSelPersoanaPrimire(){
		if($("#selPersoanaPrimire").val()){
			console.log("debug1 " + $("#selPersoanaPrimire").val());
			var persoana = null;
			listaPersoane.forEach(function(p){
				if(p.id == $("#selPersoanaPrimire").val()){
					persoana = p;
				}
			});
			$("#selCompartiment").val(persoana.idCompartiment).select2({theme: "bootstrap-5", dropdownParent: $("#modalAdaugaHotarareCJC")});
		}
	}
	
	
</script>